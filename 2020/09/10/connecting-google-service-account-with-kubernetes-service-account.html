<!DOCTYPE html> <html lang="en"><head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"><title>Connecting Google Service Account with Kubernetes Service Account</title><!-- Begin Jekyll SEO tag v2.6.1 --> <meta name="generator" content="Jekyll v3.8.7" /> <meta property="og:title" content="Connecting Google Service Account with Kubernetes Service Account" /> <meta name="author" content="Nitish Jadia" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="3 ways to access a Google Cloud Resource: Your containers and Pods might need access to other resources in Google Cloud. There are three ways to do this." /> <meta property="og:description" content="3 ways to access a Google Cloud Resource: Your containers and Pods might need access to other resources in Google Cloud. There are three ways to do this." /> <link rel="canonical" href="https://jadia.dev/2020/09/10/connecting-google-service-account-with-kubernetes-service-account" /> <meta property="og:url" content="https://jadia.dev/2020/09/10/connecting-google-service-account-with-kubernetes-service-account" /> <meta property="og:site_name" content="Nitish Jadia" /> <meta property="og:image" content="https://jadia.dev/assets/social-devops-python-preview.png" /> <meta property="og:image:height" content="628" /> <meta property="og:image:width" content="1200" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-09-10T14:52:00+00:00" /> <meta name="twitter:card" content="summary_large_image" /> <meta property="twitter:image" content="https://jadia.dev/assets/social-devops-python-preview.png" /> <meta property="twitter:title" content="Connecting Google Service Account with Kubernetes Service Account" /> <meta name="twitter:site" content="@nitishjadia" /> <meta name="twitter:creator" content="@nitishjadia" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Nitish Jadia"},"description":"3 ways to access a Google Cloud Resource: Your containers and Pods might need access to other resources in Google Cloud. There are three ways to do this.","url":"https://jadia.dev/2020/09/10/connecting-google-service-account-with-kubernetes-service-account","@type":"BlogPosting","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://jadia.dev/assets/ms-icon-310x310.png"},"name":"Nitish Jadia"},"headline":"Connecting Google Service Account with Kubernetes Service Account","dateModified":"2020-09-10T14:52:00+00:00","datePublished":"2020-09-10T14:52:00+00:00","image":{"width":1200,"height":628,"url":"https://jadia.dev/assets/social-devops-python-preview.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jadia.dev/2020/09/10/connecting-google-service-account-with-kubernetes-service-account"},"@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <link rel="stylesheet" href="/assets/main.css"><link rel="apple-touch-icon" sizes="57x57" href="/assets/apple-icon-57x57.png"> <link rel="apple-touch-icon" sizes="60x60" href="/assets/apple-icon-60x60.png"> <link rel="apple-touch-icon" sizes="72x72" href="/assets/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="76x76" href="/assets/apple-icon-76x76.png"> <link rel="apple-touch-icon" sizes="114x114" href="/assets/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="120x120" href="/assets/apple-icon-120x120.png"> <link rel="apple-touch-icon" sizes="144x144" href="/assets/apple-icon-144x144.png"> <link rel="apple-touch-icon" sizes="152x152" href="/assets/apple-icon-152x152.png"> <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-icon-180x180.png"> <link rel="icon" type="image/png" sizes="192x192" href="/assets/android-icon-192x192.png"> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="96x96" href="/assets/favicon-96x96.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"> <link rel="manifest" href="/assets/manifest.json"> <meta name="msapplication-TileColor" content="#ffffff"> <meta name="msapplication-TileImage" content="/ms-icon-144x144.png"> <meta name="theme-color" content="#ffffff"> <!-- Old diamantidis.github.io favicon entires --> <!-- <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png"/> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"> <link rel="manifest" href="/assets/site.webmanifest"> <link rel="mask-icon" href="assets/safari-pinned-tab.svg" color="#5bbad5"> <link rel="shortcut icon" href="/assets/favicon.ico"> <meta name="msapplication-TileColor" content="#da532c"> <meta name="msapplication-config" content="/assets/browserconfig.xml"> <meta name="theme-color" content="#ffffff"> --><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="https://jadia.dev/feed.xml" title="Nitish Jadia" /><script> if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) { (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61932410-4', 'auto'); ga('send', 'pageview'); ga('set', 'anonymizeIp', true); } </script> </head> <body><header class="site-header" role="banner"> <div class="wrapper"><div class="left-container"> <div class="title-wrapper"> <a class="site-title" rel="author" href="/"> <h1>Nitish Jadia</h1> </a> </div> <div class="footer-icons"> <ul> <li> <div class="social-icon"> <a href="https://twitter.com/nitishjadia" aria-label="Twitter"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://github.com/jadia" aria-label="GitHub"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://linkedin.com/in/jadianitish" aria-label="LinkedIn"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="/feed.xml" aria-label="RSS Feed"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-rss fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> </ul> </div> </div><nav class="site-nav"> <input type="checkbox" id="nav-trigger" class="nav-trigger" /> <label for="nav-trigger"> <span class="menu-icon"> <svg viewBox="0 0 18 15" width="18px" height="15px"> <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" /> </svg> </span> </label> <div class="trigger"> <!-- <a class="page-link" href="/til" title="Today I Learned">Today I Learned</a> <a class="page-link" href="/howto" title="How To">How To</a> --> <a class="page-link" href="/uses" title="Uses">Uses</a><a class="page-link" href="/about" title="About">About</a><a class="page-link" href="/archive" title="Archive">Archive</a><a class="page-link" href="/tags" title="Tags">Tags</a></div> </nav></div> </header><main class="page-content" aria-label="Content"> <div class="wrapper"> <article class="post"> <header class="post-header"> <h1> <span class="post-title">Connecting Google Service Account with Kubernetes Service Account</span> </h1> <div class="post-subheader"> <span class="post-date"> September 10, 2020 </span> <span class="post-divider">-</span> <span class="post-minutes"> 4 min read </span> <div class="outer-post-tags"> <div class="post-tags"> <a class="post-tag" href="/tags#Kubernetes" title="Kubernetes">Kubernetes</a> </div> </div> </div> </header> <div class="post-content"> <h2 id="3-ways-to-access-a-google-cloud-resource">3 ways to access a Google Cloud Resource:</h2> <p>Your containers and Pods might need access to other resources in Google Cloud. There are three ways to do this.</p> <p>Below is a part extracted from the <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/security-overview#giving_pods_access_to_resources">Google Docs</a>:</p> <blockquote> <h3 id="workload-identity-recommended"><strong>Workload Identity (recommended)</strong></h3> <p>The simplest and most secure way to authorize Pods to access Google Cloud resources is with <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity">Workload Identity</a>. Workload identity allows a Kubernetes service account to run as a <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity">Google Cloud service account</a>. Pods that run as the Kubernetes service account have the permissions of the Google Cloud service account.</p> <p>Workload Identity can be used with <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/sandbox-pods">GKE Sandbox</a>.</p> <h3 id="node-service-account"><strong>Node Service Account</strong></h3> <p>Your Pods can also authenticate to Google Cloud using the Kubernetes clusters’ <a href="https://cloud.google.com/compute/docs/access/service-accounts">service account</a> credentials from metadata. However, these credentials can be reached by any Pod running in the cluster if Workload Identity is not enabled. Create and configure a custom service account that has the <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/hardening-your-cluster#use_least_privilege_sa">minimum IAM roles</a> that are required by all the Pods running in the cluster.</p> <p>This approach is not compatible with <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/sandbox-pods">GKE Sandbox</a> because GKE Sandbox blocks access to the metadata server.</p> <h3 id="service-account-json-key"><strong>Service Account JSON key</strong></h3> <p>A third way to grant credentials for Google Cloud resources to applications is to manually use the <a href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys">service account’s key</a>. This approach is strongly discouraged because of the difficulty of securely managing account keys.</p> <p>You should use <a href="https://cloud.google.com/kubernetes-engine/docs/tutorials/authenticating-to-cloud-platform">application-specific Google Cloud service accounts to provide credentials</a> so that applications have the minimal necessary permissions. Each service account is assigned only the IAM roles that are needed for its paired application to operate successfully. Keeping the service account application-specific makes it easier to revoke its access in the case of a compromise without affecting other applications. Once you have assigned your service account the correct IAM roles, you can create a JSON service account key, and then mount that into your Pod using a Kubernetes <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/secret">Secret</a>.</p> </blockquote> <h2 id="connecting-google-service-account-with-kubernetes-service-account">Connecting Google service account with Kubernetes service account</h2> <p>This requires Workload identity to work.</p> <h1 id="pre-requisites">Pre-requisites:</h1> <ol> <li>Google service account with roles required by the application.</li> </ol> <h3 id="conditions">Conditions:</h3> <ol> <li>The cluster MUST have workload identity enabled</li> <li>The node pool’s <code class="language-plaintext highlighter-rouge">workload-metadata</code> MUST be set as <code class="language-plaintext highlighter-rouge">GKE_METADATA</code> instead of <code class="language-plaintext highlighter-rouge">GCE_METADATA</code>.</li> <li>A binding between the GSA(Google service account) and KSA(Kubernetes service account) MUST exist</li> </ol> <h2 id="enable-workload-identity-in-the-gke-cluster">Enable workload identity in the GKE cluster</h2> <p>Source: <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity">Workload Identity | Kubernetes Engine Documentation | Google Cloud</a></p> <h3 id="new-cluster"><strong>New Cluster:</strong></h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">PROJECT_ID</span><span class="o">=</span>jadia-project
<span class="nv">CLUSTER_NAME</span><span class="o">=</span>ptdevops

gcloud container clusters create <span class="nv">$CLUSTER_NAME</span> <span class="se">\</span>
  <span class="nt">--release-channel</span> regular <span class="se">\</span>
  <span class="nt">--workload-pool</span><span class="o">=</span><span class="nv">$PROJECT</span>.svc.id.goog
</code></pre></div></div> <h3 id="existing-cluster"><strong>Existing cluster</strong>:</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">PROJECT_ID</span><span class="o">=</span>jadia-project
<span class="nv">CLUSTER_NAME</span><span class="o">=</span>playops

gcloud container clusters update <span class="nv">$CLUSTER_NAME</span> <span class="se">\</span>
  <span class="nt">--workload-pool</span><span class="o">=</span><span class="nv">$PROJECT_ID</span>.svc.id.goog
</code></pre></div></div> <p>Source: <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#enable_on_existing_cluster">https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#enable_on_existing_cluster</a></p> <p>or you can go and edit the cluster from web interface and enable <em>workload identity</em>.</p> <p><strong>Enable workload identity in the node-pool:</strong></p> <p>Do this to all the node pools in the cluster</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CLUSTER_NAME</span><span class="o">=</span>playops
<span class="nv">NODE_POOL_NAME</span><span class="o">=</span>standard-pool-1

gcloud container node-pools update <span class="nv">$NODE_POOL_NAME</span> <span class="se">\</span>
  <span class="nt">--cluster</span><span class="o">=</span><span class="nv">$CLUSTER_NAME</span> <span class="se">\</span>
  <span class="nt">--workload-metadata</span><span class="o">=</span>GKE_METADATA
</code></pre></div></div> <p>source: <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#option_1_node_pool_modification">https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#option_1_node_pool_modification</a></p> <h3 id="create-a-binding-between-the-gsa-and-ksa">Create a binding between the GSA and KSA</h3> <ul> <li>Create a GSA with the required roles.</li> <li>Create KSA with annotation about the GSA</li> </ul> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">NAMESPACE</span><span class="o">=</span>default
<span class="nv">GCLOUD_SERVICE_ACCOUNT_NAME</span><span class="o">=</span>test-gsa
<span class="nv">PROJECT_NAME</span><span class="o">=</span>playops
<span class="nv">KUBE_SERVICE_ACCOUNT_NAME</span><span class="o">=</span>k8s-service-account

kubectl annotate serviceaccount <span class="se">\</span>
  <span class="nt">--namespace</span> <span class="nv">$NAMESPACE</span> <span class="se">\</span>
    <span class="nv">$KUBE_SERVICE_ACCOUNT_NAME</span> <span class="se">\</span>
    iam.gke.io/gcp-service-account<span class="o">=</span><span class="nv">$GCLOUD_SERVICE_ACCOUNT_NAME</span>@<span class="nv">$PROJECT_NAME</span>.iam.gserviceaccount.com
</code></pre></div></div> <p>or just add annotation as:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">iam.gke.io/gcp-service-account</span><span class="pi">:</span> <span class="s">test-gsa@playops.iam.gserviceaccount.com</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">k8s-service-account</span>
</code></pre></div></div> <ul> <li>Create binding</li> </ul> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">NAMESPACE</span><span class="o">=</span>default
<span class="nv">KSA</span><span class="o">=</span>k8s-service-account
<span class="nv">PROJECT_NAME</span><span class="o">=</span>playops
<span class="nv">GSA</span><span class="o">=</span>test-gsa@<span class="nv">$NAMESPACE</span>.iam.gserviceaccount.com

gcloud iam service-accounts add-iam-policy-binding <span class="se">\ </span>
<span class="nt">--role</span> roles/iam.workloadIdentityUser <span class="se">\</span>
<span class="nt">--member</span> <span class="s2">"serviceAccount:</span><span class="nv">$PROJECT_NAME</span><span class="s2">.svc.id.goog[</span><span class="nv">$NAMESPACE</span><span class="s2">/</span><span class="nv">$KSA</span><span class="s2">]"</span> <span class="nv">$GSA</span>
</code></pre></div></div> <h3 id="test-if-workload-identity-is-working-or-not">Test if workload identity is working or not</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">--image</span> google/cloud-sdk:slim <span class="se">\</span>
<span class="nt">--serviceaccount</span> k8s-service-account <span class="se">\</span>
<span class="nt">--namespace</span> default workload-identity-test
</code></pre></div></div> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Inside the pod</span>
gcloud auth list

<span class="c">#OUTPUT&gt;</span>
<span class="c">#root@workload-identity-test:/# gcloud auth list</span>
<span class="c">#              Credentialed Accounts</span>
<span class="c">#ACTIVE  ACCOUNT</span>
<span class="c">#*       test-gsa@playops.iam.gserviceaccount.com</span>
</code></pre></div></div> <h2 id="references">References</h2> <ol> <li> <p><a href="https://medium.com/google-cloud/updating-google-container-engine-vm-scopes-with-zero-downtime-50bff87e5f80">Dinesh, Sandeep. “Updating Google Kubernetes Engine VM Scopes with Zero Downtime.” Medium. Last modified February 6, 2018. Accessed September 10, 2020.</a></p> </li> <li> <p><a href="https://dzone.com/articles/enabling-gke-workload-identity">“Enabling GKE Workload Identity - DZone Cloud.” Dzone.Com. Accessed September 10, 2020</a></p> </li> <li> <p><a href="https://www.youtube.com/watch?v=2HmDZXbfA80">“Node Management in GKE (Cloud Next ’19) - YouTube.” Accessed September 10, 2020</a></p> </li> </ol> </div> <div class="share"> <strong>Share: </strong> <a href="//twitter.com/share?text=Connecting+Google+Service+Account+with+Kubernetes+Service+Account&url=https%3A%2F%2Fjadia.dev%2F2020%2F09%2F10%2Fconnecting-google-service-account-with-kubernetes-service-account" aria-label="Share on Twitter" onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> <a href="//www.facebook.com/sharer.php?t=Connecting+Google+Service+Account+with+Kubernetes+Service+Account&u=https%3A%2F%2Fjadia.dev%2F2020%2F09%2F10%2Fconnecting-google-service-account-with-kubernetes-service-account" aria-label="Share on Facebook" onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i> </span> </a> <a href="//www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fjadia.dev%2F2020%2F09%2F10%2Fconnecting-google-service-account-with-kubernetes-service-account" aria-label="Share on LinkedIn" onclick="window.open(this.href, 'linkedin-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div><div id="disqus_thread"></div> <script> var disqus_config = function () { this.page.url = 'https://jadia.dev/2020/09/10/connecting-google-service-account-with-kubernetes-service-account'; this.page.identifier = 'https://jadia.dev/2020/09/10/connecting-google-service-account-with-kubernetes-service-account'; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://jadia-dev.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></article> </div> </main><footer class="site-footer"> <data class="u-url" href="/"></data> <div class="footer-icons"> <ul> <li> <div class="social-icon"> <a href="https://twitter.com/nitishjadia" aria-label="Twitter"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://github.com/jadia" aria-label="GitHub"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://linkedin.com/in/jadianitish" aria-label="LinkedIn"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="/feed.xml" aria-label="RSS Feed"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-rss fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> </ul> </div> <div class="wrapper"> <p>Built with <i class="fa fa-heart" aria-hidden="true"></i>, <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://pages.github.com/"> Github Pages</a> </p> <p> © Copyright 2023 Nitish Jadia </p> </div> </footer></body> </html>
